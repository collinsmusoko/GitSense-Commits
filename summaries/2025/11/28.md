# Activity Summary for 28/11/2025

## 08:54:27
The code changes primarily focus on enhancing and refining a leave management system across its API service and administrative frontend component.

In `/Users/collin/projects/ngex/ngex-api/src/services/leave_request.service.js` (28/11/2025, 08:13:35):
The `leave_request.service.js` file introduces significant logic for creating and processing leave requests. It imports a wide array of models and utilities, indicating a complex, interconnected system.
- **Extensive Imports:** The service relies on numerous models (e.g., `Requests`, `User`, `Companies`, `Approvals`, `Notifications`, `PayrollProcess`), external libraries (`@nathangroup/leave`, `lodash`, `moment-timezone`), and custom helpers/utilities for notifications, emails, S3 uploads, and pay item creation.
- **Comprehensive Constants:** A `CONST` object is defined with various statuses, leave types (e.g., 'pilgrimage leaves', 'maternity leaves', 'annual leaves'), durations, and conditions, highlighting a highly configurable leave system.
- **`createLeaveRequest` Function:** This function orchestrates the entire leave application process:
    - **User and Approval Flow Validation:** It fetches applicant and manager details, rigorously checks if an approval flow is configured, and ensures the applicant has a reporting manager.
    - **Dynamic Approver Assignment:** It dynamically updates approver levels within the approval flow, replacing placeholder IDs (`line_manager_id`, `senior_manager_id`) with actual user IDs and handling unique approvers.
    - **Leave Balance and Eligibility Checks:** It performs detailed calculations and validations for leave balance, considering parameters like `unpaid_leave_capped`, `apply_below_zero`, `max_allowed`, and `used_lumpsum`. It also verifies half-day eligibility for specific leave types.
    - **Air Ticket Integration:** For 'Annual Leaves', it includes logic to capture `air_ticket` details, including departure/arrival countries/airports and a specific `travel_date`.
    - **Automated Approval Logic:** A key feature introduced is the auto-approval mechanism. If an assigned approver is on leave during the requested period, their approval is marked 'Auto Approved', and an `approval_substitute` (proxy approver) is inserted into the approval chain.
    - **Payroll Integration:** The service prepares the leave request object with a `payroll_process` field and calls `createNewPayItems` upon successful and completed leave applications, indicating integration with a payroll system.
    - **Application Logging:** `appliction_log` is updated to record approval actions, especially for auto-approved cases.

In `/Users/collin/projects/ngex/ngex-admin/components/reuseable/createLeaves.vue` (28/11/2025, 08:37:15):
The `createLeaves.vue` component provides the user interface for applying for leaves in the admin panel.
- **Leave Summary Display:** It prominently displays `no_of_days`, `remaining_leaves`, `unpaid_leave_count` (for overflow scenarios), and a detailed `sick_leave_breakdown` (Paid, HalfPaid, Unpaid), offering clear visibility of leave entitlements. Loading states are indicated with progress circulars.
- **Dynamic Form Fields:** The form adjusts based on selections:
    - **Leave Type and Options:** Allows selecting a leave type (with translated names) and a half-day/full-day option if `isHalfDayAvailable`.
    - **Date Pickers:** Provides intuitive date pickers for `from_date`, `to_date`, with validation for minimum dates and locale support.
    - **Air Ticket Fields:** Conditionally displays detailed fields for `Departure Country/Airport`, `Arrival Country/Airport`, and `Travel Date` exclusively for 'Annual Leaves' when the `Air Ticket` checkbox is selected. The travel date picker excludes declared holidays.
- **Document Upload and Leave Buddy:** Users can upload supporting documents (`certificate`) with required validation and select a `leave_buddy_id`.
- **Reason Field:** A mandatory `reason` text area is included.
- **Submission Logic:** The "Submit" button (`applyLeave`) has extensive disabling conditions based on various states and computed properties (e.g., `newLeaveProgress`, `computeAddRequestButton`, `computedCheckLeaveBlackout`, `computeHajjLeave`), preventing invalid submissions.
- **Component Data:** The script section defines various data properties to manage form state, leave counts, loading indicators, validation rules, holiday lists (`delcared_holidays`), and specific configurations like `min_days_before_start`, `blackout_start_date`, and `blackout_end_date`, hinting at blackout period functionality. It also uses `@nathangroup/leave` for shared leave logic.

**Patterns and Recurring Elements:**
- **Comprehensive Leave Management:** Both files are integral to a feature-rich leave management system, covering application, approval, validation, and payroll integration.
- **Shared Logic Library:** The `@nathangroup/leave` library is utilized by both the backend service and the frontend component, suggesting a standardized approach to leave-related calculations and rules.
- **Detailed Date and Time Handling:** Both components extensively manage dates (`from_date`, `to_date`, `travel_date`, `blackout_start_date`, `blackout_end_date`, `delcared_holidays`), emphasizing precision in leave duration and eligibility.
- **Approval Workflow Integration:** A robust multi-level approval process is evident, involving dynamic approver assignment and automated substitute approvals.
- **User-Specific Configuration:** The system tailors leave options and validations based on user-specific data (e.g., `applicant.leaves`, `obj_leave_type`, `selectedEmp`, `userType`).
- **Internationalization (i18n):** The frontend component shows clear support for multiple languages with `$t()` directives and locale-aware date pickers.
- **Modularity:** The use of helper functions, email templates, and a dedicated queue (`bulk_leaves_upload.queue`) indicates a modular architecture.
- **Emphasis on Validation and User Feedback:** Both parts incorporate numerous validation checks and UI feedback mechanisms (e.g., error messages, progress indicators, success alerts) to guide users through the application process.